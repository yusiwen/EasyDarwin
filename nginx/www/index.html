<!DOCTYPE html>
<html>

<head>
    <title>EasyDarwin</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="./adminlte-2.3.6/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./adminlte-2.3.6/font-awesome-4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./adminlte-2.3.6/ionicons-2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="./adminlte-2.3.6/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="./adminlte-2.3.6/dist/css/skins/skin-green.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script src="./adminlte-2.3.6/plugins/jQuery/jquery-2.2.3.min.js"></script>
    <script src="./adminlte-2.3.6/bootstrap/js/bootstrap.min.js"></script>
    <script src="./adminlte-2.3.6/dist/js/app.js"></script>
    <script src="./adminlte-2.3.6/plugins/slimScroll/jquery.slimscroll.min.js"></script>
    <link rel="stylesheet" href="./adminlte-2.3.6/plugins/iCheck/all.css">
    <script src="./adminlte-2.3.6/plugins/iCheck/icheck.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/md5/jquery.md5.js"></script>
    <script src="./adminlte-2.3.6/plugins/input-number/jquery.inputnumber.js"></script>
    <link rel="stylesheet" href="./adminlte-2.3.6/plugins/gritter/jquery.gritter.css">
    <script src="./adminlte-2.3.6/plugins/gritter/jquery.gritter.js"></script>
    <link rel="stylesheet" href="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.css">
    <script src="./adminlte-2.3.6/plugins/loadmask/jquery.loadmask.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/validator/validator.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/bootbox/bootbox.min.js"></script>
    <script src="./adminlte-2.3.6/plugins/cookie/jquery.cookie.min.js"></script>
    <script src="./easyui/easyloader.js"></script>

    <link rel="stylesheet" href="./css/common.css">
    <script src="./js/common.js"></script>
    <style>
        .channel .thumbnail {
            position: relative;
        }
        
        .channel .mask {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .channel.offline .mask {
            display: block;
        }
        
        .left_div {
            position: absolute;
            top: 12%;
            left: 2.5%;
            width: 18%;
            height: 81%;
            cursor: pointer;
        }
        
        .right_div {
            position: absolute;
            top: 18%;
            right: 3%;
            width: 18%;
            height: 69%;
            cursor: pointer;
        }
    </style>
</head>

<body class="hold-transition skin-green sidebar-mini ">
    <script>
        try {
            $(document).on("transitionend", ".content-wrapper", function() {
                localStorage["sidebar-collapse"] = $("body").hasClass("sidebar-collapse") ? "sidebar-collapse" : "";
            });
            $("body").addClass(localStorage["sidebar-collapse"]);
        } catch (e) {}
    </script>
    <div class="wrapper">

        <header class="main-header">

            <a href="#" class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini">ED</span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg">EasyDarwin</span>
            </a>

            <nav class="navbar navbar-static-top" role="navigation">
                <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <li>
                            <a id="btn-modify-pwd" href="#" data-toggle="modal" data-target="#pwd-dlg"><i
	                                class="fa fa-key"></i> 修改密码</a>
                        </li>
                        <li>
                            <a id="btn-logout" href="javascript:void(0);"><i class="fa fa-power-off"></i> 注 销</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
        <aside class="main-sidebar main-sidebar-gray">
            <section class="sidebar">
                <ul class="sidebar-menu">
                    <li class="treeview">
                        <a href="index.html">
                            <i class="fa fa-video-camera"></i>
                            <span>直播推流列表</span>
                        </a>
                    </li>
                    <li class="treeview">
                        <a href="config.html">
                            <i class="fa fa-cogs"></i>
                            <span>基本配置</span>
                        </a>
                    </li>
                    <li class="treeview">
                        <a href="about.html">
                            <i class="fa fa-support"></i>
                            <span>服务运行信息</span>
                        </a>
                    </li>
                    <li class="treeview">
                        <a href="easypusher.html">
                            <i class="fa   fa-sign-in"></i>
                            <span>EasyPusher</span>
                        </a>
                    </li>
                    <li class="treeview">
                        <a href="easyplayer.html">
                            <i class="fa  fa-toggle-right"></i>
                            <span>EasyPlayer</span>
                        </a>
                    </li>
                </ul>
            </section>
        </aside>

        <div class="modal fade" id="pwd-dlg">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
                        <h4 class="modal-title">修改密码</h4>
                    </div>
                    <form id="pwd-form" class="form-horizontal" data-toggle="validator" data-disable="false">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="input-old-pwd" class="col-sm-3 control-label">
	                                原密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
                                <div class="col-sm-8">
                                    <input id="input-old-pwd" type="password" name="oldPwd" class="form-control" required>
                                    <span class="help-block with-errors"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="input-new-pwd" class="col-sm-3 control-label">
	                                新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
                                <div class="col-sm-8">
                                    <input id="input-new-pwd" type="password" name="newPwd" class="form-control" required>
                                    <span class="help-block with-errors"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="input-new-pwd2" class="col-sm-3 control-label">
	                                确认新密码
	                                <span class="text-red">*</span>
	                                :
	                            </label>
                                <div class="col-sm-8">
                                    <input id="input-new-pwd2" type="password" name="newPwd2" class="form-control" data-match="#input-new-pwd" data-match-error="两次密码输入不一致" required>
                                    <span class="help-block with-errors"></span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">确定</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="content-wrapper" style="background-color: white">
            <section class="content">
                <div class="container-fluid">
                    <table id="session-table" style="display:none" class="easyui-datagrid hide" width="100%" height="400px;" rownumbers="true" pagination="true" title="直播流列表" data-options="onBeforeLoad : onBeforeLoad">
                        <thead>
                            <tr>
                                <th field="index" width="10%" align="center" sortable="true">序号</th>
                                <th field="Channel" width="20%" align="center" sortable="false">通道</th>
                                <th field="name" width="25%" align="right" sortable="true">名称</th>
                                <th field="NumOutputs" width="20%" align="right" sortable="true">在线人数</th>
                                <th field="url" width="20%" align="center" formatter="formatOpt" sortable="false">操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="box box-success box-solid" style="width: 99.5%;margin: auto;margin-top:30px;margin-left: 0.5%;">
                    <div class="box-header with-border">
                        <h3 class="box-title">EasyDarwin系统拓扑图</h3>
                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                        </button>
                        </div>
                        <!-- /.box-tools -->
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body" style="display: block;">
                        <div class="left_div" onclick="top.location.href = '/easyplayer.html'"></div>
                        <div class="right_div" onclick="top.location.href = '/easypusher.html'"></div>
                        <img style="width: 100%;height: 100%; " src="./img/introduction.png "></img>
                    </div>
                    <!-- /.box-body -->
                </div>
                <script>
                    var openurls = ["/ ", "/easyplayer.html ", "/easypusher.html "];
                    var token = $.cookie("token ") || " ";
                    if (!token && $.inArray(location.pathname, openurls) < 0) {
                        top.location.href = "/login.html ";
                    }
                    if (!token) {
                        // $(".treeview [href=/config.html] ").closest(".treeview ").hide();
                        // $(".treeview [href=/about.html] ").closest(".treeview ").hide();
                    }
                    $("#btn-logout ").click(function() {
                        $.get(_url + "/logout ");
                        $.cookie("token ", " ", {
                            expires: -1
                        });
                        $.cookie("username ", " ", {
                            expires: -1
                        });
                        top.location.href = "/login.html ";
                    })
                    $('#pwd-form').validator().on('submit', function(e) {
                        if (!e.isDefaultPrevented()) {
                            e.preventDefault();
                            var _oldPwd = $("#pwd-form [name=oldPwd] ").val();
                            var _newPwd = $("#pwd-form [name=newPwd] ").val();
                            if (!/^[a-zA-Z0-9]+$/.test(_newPwd) || _newPwd.length > 16) {
                                $.gritter.add("密码长度不超过16字符，为英文或数字! ");
                                return false;
                            }
                            $("#pwd-form [type=submit] ").prop("disabled ", true);
                            $.ajax({
                                type: "GET ",
                                url: _url + "/modifypassword ",
                                data: {
                                    oldpassword: $.md5(_oldPwd),
                                    newpassword: $.md5(_newPwd)
                                },
                                global: false,
                                success: function(data) {
                                    try {
                                        console.log(data);
                                        var ret = JSON.parse(data);
                                        $.cookie("token ", ret.EasyDarwin.Body.Token);
                                        $.gritter.add({
                                            text: "修改密码成功! ",
                                            class_name: "gritter-info "
                                        });
                                        $("#pwd-dlg ").modal("hide ");
                                        return;
                                    } catch (e) {}
                                    $.gritter.add("修改密码不成功! ");
                                },
                                error: function(xhr, ts, err) {
                                    $.gritter.add("修改密码不成功! ");
                                },
                                complete: function() {
                                    $("#pwd-form [type=submit] ").prop("disabled ", false);
                                }
                            });
                        }
                    });
                </script>
                <script>
                    function formatOpt(val, row, idx) {
                        var btns = "<div class='btn-group'>";
                        btns += "<a class='btn btn-xs btn-success' href='javascript:playLive();'><i class='fa fa-play'></i> 播放</a>";
                        btns += "</div>";
                        return btns;
                    }

                    function onBeforeLoad(param) {
                        var start = (param.page - 1) * param.rows;
                        var end = param.page * param.rows;
                        $.ajax("/api/v1/getrtsplivesessions", {
                            cache: false
                        }).then(function(data) {
                            try {
                                data = JSON.parse(data);
                                var total = data.EasyDarwin.Body.SessionCount;
                                var sessions;
                                if (total == 0) {
                                    $.gritter.add("暂无直播流数据");
                                    sessions = [];
                                } else {
                                    sessions = data.EasyDarwin.Body.Sessions;
                                }
                                var rows = sessions.slice(start, end);
                                $("#session-table").datagrid("loadData", {
                                    total: total,
                                    rows: rows
                                });
                            } catch (e) {
                                return $.Deferred().reject(e);
                            }
                        }).fail(function(e,
                            ts, xhr) {
                            console.log(e);
                            $.gritter.add("获取信息失败");
                        })
                    }

                    function playLive() {
                        var row = $("#session-table").datagrid("getSelected");
                        console.log(row.url);
                        var url = row.url.replace(/(.+)\/\/(.+)\/\/(.+)/, "$1//$2/$3");
                        console.log(url);
                        $.cookie("videoUrl", url);
                        $.cookie("videoTitle", row.name);
                        top.location.href = "/easyplayer_rtsp.html";
                    }
                    $(document).on("click", ".channel img", function(e) {
                        var $img = $(this);
                        var $channel = $img.closest(".channel");
                        var
                            channel = $channel.data("channel");
                        $("body").mask("加载中...", 100);
                        $.ajax({
                            type: "GET",
                            url: _url + "/getchannelstream",
                            data: {
                                Channel: channel["Channel"],
                                Protocol: isPC() ? "RTMP" : "HLS",
                                Line: "local",
                                From: "lan"
                            },
                            success: function(data) {
                                try {
                                    var ret = JSON.parse(data);
                                    var videoUrl = ret.EasyDarwin.Body.URL;
                                    if (!videoUrl) {
                                        throw new Error('URL is empty');
                                    }
                                    $.cookie("videoUrl", videoUrl);
                                    $.cookie("videoImg", $img.attr("src"));
                                    $.cookie("channel",
                                        channel["Channel"]);
                                    $.cookie("channelName", channel["Name"]);
                                    top.location.href = "./play.html";
                                    return;
                                } catch (e) {
                                    $.gritter.add({
                                        text: '获取视频流失败!',
                                        class_name: 'gritter-error'
                                    });
                                    console.log(e);
                                }
                            },
                            error: function(xhr,
                                ts, err) {
                                $.gritter.add({
                                    text: '获取视频流失败!',
                                    class_name: 'gritter-error'
                                });
                            },
                            complete: function() {
                                $("body").unmask();
                            }
                        });
                    })
                </script>
            </section>
        </div>
        <!-- content-wrapper -->

        <footer class="main-footer">
            <div class="pull-right hidden-xs">
                EasyDarwin
            </div>
            <strong>Copyright &copy; 2017 <a href="#">www.easydarwin.org</a>.</strong> All rights reserved.
        </footer>
    </div>
    <!-- wrapper-->
</body>

</html>